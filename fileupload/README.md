# 이미지, 영상 업로드를 위한 서버

## goal
1. webflux를 이용한 비동기 업로드 서버
2. 영상 파일 인코딩을 통한 효율적 저장

## 할일
- [x] 동영상 파일을 업로드 후 인코딩
- [x] 이미지 파일을 업로드 후 인코딩
- [x] 미디어 파일을 서버로부터 호출하는 api
- [ ] filter를 통해 토큰 검증
- [ ] 파일 메타데이터 db 저장


## 고민점

### 1. 메인 서버와 별도로 분리된 서버
- 어떻게 jwt를 통한 인증을 처리할 것인가
  - 메인 서버에서 jwt 토큰을 검증하는 api를 만든다.
  - 업로드 서버로 들어온 jwt 토큰을 메인 서버의 검증 api를 통해 검증한다.
  - webfilter 단에서 검증한다.


### 2. 용량이 큰 영상 파일을 어떻게 인코딩해 효율적으로 처리할 것인가
- 인코딩은 FFmpeg 라이브러리를 사용.
- scheduler를 통해 별도의 스레드를 만들어 거기서 인코딩 처리.

### 3. 파일을 어디에 저장할 것인가
- S3의 외부 서비스를 이용 혹은 업로드 서버가 올라갈 ec2 로컬에 저장하는 방식
- 사용량이나 편의성을 보면 ec2에 저장하도록 설정

### 4. 파일을 저장하고 db에 어떤 내용을 넣을 것인가
업로드 서버는 업로드만 처리하자. 사용자가 파일을 업로드 하면 서버에서 업로드 처리 후 파일 url, 파일명을 리턴 
클라이언트에서는 해당 url을 받아 게시글 작성 시 함께 리퀘스트?   
차라리 전달받을 시 업로드 서버에서 db에 미디어 정보 저장, 리턴에서 get api url과 해당 데이터 pk를 함께 전송.
-> 게시글 작성 api에 해당 정보를 함께 보내서 게식글 테이블에 fk로 미디어 pk 저장
-> 1:N 관계인데 서버가 분리돼있는 상태. -> 중계테이블을 생성해 관리 
업로드 서버에서도 db에 메타데이터 저장 필요
- 파일 pk
- 올린 유저 id -> jwt토큰을 통해 획득 가능
- 게시글 ?
  - 파일이 업로드되고 db에 insert 순간에는 게시글 id가 확정이 안돼있음 차라리 게시글 테이블에서 외부키로 파일 id를 전달받아 처리
  - 게시글 pk : 파일 pk 의 중계테이블 vs 미디어 테이블에 게시글 id 칼럼을 만들고 게시글 서버에서 리턴된 미디어 pk를 사용해 미디어 테이블에 접근해 게시글 id insert
  - 게시글을 db에 insert, 게시글 서버에서 미디어 table에서 해당 미디어pk에 해당하는 레코드에 자신의 게시글 pk 삽입 처리 
- 파일명
- 파일 URL
- 파일 확장자
- 현재 상태
- 업로드 시간